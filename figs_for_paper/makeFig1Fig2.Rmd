
# Setup for simulation
```{r setup-simulation}
rm(list=ls())
#.rs.restartR()
run_simulation  = T # TODO: currently ignored
save_simulation = T # TODO: currently ignored
run_figures     = T
save_figures    = T
sparse_heatmap  = F
mc_cores=10
gset = list(
  Nmeas             = 16,
  Nfreq             = 2^8,
  nfreq_cvxr        = 2^8,
  Nfine             = 288,
  trace_global      = 0,
  report_global     = 1,
  maxit_sa          = 5e2,
  maxit_bfgs        = 10, 
  timelimit_cvxr    = 'bfgs',
  Amp_global        = NaN,
  Nmin_2lat         = 4,
  Nmax_2lat         = 12,
  nrep              = 20,
  regL1             = 1 
)
```

```{r setup-simulation-2}
require(devtools)
require(ggplot2)
require(annmatrix)
require(ggplotify)
require(patchwork)
require(parallel)
require(data.table)
require(stringr)
require(CVXR)
source('plotConfig.R')
load_all()

freqs_global  = seq(from=1,to=24,length.out=gset$Nfreq)

Nmeas         = gset$Nmeas
Nfreq         = gset$Nfreq
Nfine         = gset$Nfine        
trace_global  = gset$trace_global  
report_global = gset$report_global
maxit_sa      = gset$maxit_sa
maxit_bfgs    = gset$maxit_bfgs
Amp_global    = gset$Amp_global

tau = c(1:Nfine)/Nfine -1/Nfine
# set up controls
ctrl_cts_arb_bfgs = list(costfun_choice='svdpower', optim_method='L-BFGS-B',
            trace=trace_global,REPORT=report_global,maxit=maxit_bfgs)

ctrl_cts_arb_sa   = list(costfun_choice='svdpower',optim_method='simul_anneal',
            tfun_choice='brownian-torus',tfun_mean=0,tfun_sd=.1,
            trace=trace_global,REPORT=report_global,maxit=maxit_sa) 

ctrl_cts_lat_bfgs = list(costfun_choice='svdpower_2lattice',
            optim_method='L-BFGS-B',
            trace=trace_global,REPORT=report_global,maxit=maxit_bfgs)

ctrl_cts_lat_sa   = list(costfun_choice = 'svdpower_2lattice',
            optim_method = 'simul_anneal',
            tfun_choice  = 'unif-with-bdry',tscale_unif_with_bdry=1/10,
            trace=trace_global,REPORT=report_global,maxit=maxit_sa)

ctrl_disc_arb_sa =list(costfun_choice='svdpower_discrete',
            optim_method='simul_anneal',
            tfun_choice='single-flip',Nfine=Nfine,Nmeas=Nmeas,
            trace=trace_global,REPORT=report_global,maxit=maxit_sa)
  
ctrl_disc_arb_cvxr = list(costfun_choice='svdpower_discrete',
            optim_method='cvxr',
            maxit=1e9,time_limit=gset$timelimit_cvxr,MIPGapAbs=.01,
            cvxr_verbose=T,costfun_type='Linfty',
            fmin=min(freqs_global),
            fmax=max(freqs_global),Nfreq=gset$nfreq_cvxr,
            lattice_cstr='none',Nfine=Nfine,Nmeas=Nmeas,
            trace=trace_global,REPORT=report_global)

ctrl_disc_lat_sa = list(costfun_choice = 'svdpower_2lattice_discrete',
             optim_method   = 'simul_anneal',
             tfun_choice    = 'unif-with-bdry-discrete',tscale= 2,
             trace=trace_global,REPORT=report_global,maxit=maxit_sa)

extract_info_from_result=function(res,tag,Nmeas=gset$Nmeas,runtime_tot,...){
  tagsp=strsplit(tag,'_')
  if(hasArg('runtime_tot')){
    # lubridate ensures that units are always in seconds
    runtime=runtime_tot %>% lubridate::as.duration() %>% as.numeric()
  }else{
    runtime=res$runtime %>% lubridate::as.duration() %>% as.numeric()
  }
  if (length(res$mtvalue)<Nmeas){
    stop('degenerate measurement times')
  }
  return(annmatrix(
               x = matrix(sort(res$mtvalue),nrow=1),
            rann = data.frame(power   = 1-res$fvalue,
                              runtime = runtime,
                              tag     = tag,
                              cts     = tagsp[[1]][1],
                              lattice = tagsp[[1]][2],
                              solver  = tagsp[[1]][3]),
            cann = data.frame(time=c(1:Nmeas))))
}

update_amm=function(Lnow,gset,tag,wrapped=F){
  for (ii in c(1:gset$nrep)){
    res = Lnow[[ii]]
    if (wrapped){
      amm = rbind(amm,extract_info_from_result(res=res$res_best,tag=tag,
                                               runtime_tot=res$time_tot)) 
    }else{
      amm = rbind(amm,extract_info_from_result(res=res,tag=tag)) 
    }
  }
  return(amm)  
}
amm=NULL
```

# Run the stats
## BFGS
```{r bfgs}
Lnow = c(1:gset$nrep) %>% as.list() %>%  mclapply(mc.cores=mc_cores,FUN=function(ii){
  var0_cts_arb_bfgs = runif(gset$Nmeas)
  resu_cts_arb_bfgs = opt_osc_power(dvar0    = var0_cts_arb_bfgs, 
                                    control  = ctrl_cts_arb_bfgs,
                                    freqs    = freqs_global,
                                    Amp      = NaN,
                                    cfuntype = 'ncp',
                                    regL1    = gset$regL1)
})
amm=update_amm(Lnow,gset,tag='cts_arb_bfgs',wrapped=F)

Lnow = c(1:gset$nrep) %>% as.list() %>%  mclapply(mc.cores=mc_cores,FUN=function(ii){
  var0_cts_lat_bfgs = list(x0=c(shift2=runif(1),scale1=0.5,scale2=.5,shift1=0),
                           lat1 =NULL,lat2 =NULL) 
  return(resu_cts_arb_bfgs = wrapper_sweep_lattice(opt_osc_power,
                                    Nvals    = c(gset$Nmin_2lat:gset$Nmax_2lat),
                                    Nmeas    = Nmeas,
                                    cts_flag = T,
                                    dvar0    = var0_cts_lat_bfgs,
                                    control  = ctrl_cts_lat_bfgs,
                                    freqs    = freqs_global,
                                    Amp      = NaN,
                                    cfuntype= 'ncp',
                                    regL1    = gset$regL1)  )
})
amm=update_amm(Lnow,gset,tag='cts_lat_bfgs',wrapped=T)

```

## CVXR
```{r cvxr}
freqs_cvxr=seq(from=1,to=24,length.out=gset$nfreq_cvxr)
ctrl_disc_arb_cvxr$time_limit =median(amm@runtime)#60
res = opt_osc_power(dvar0  = NULL,
             control = ctrl_disc_arb_cvxr,
             freqs   = freqs_cvxr,
             Amp     = NaN,
             tau     = tau,
             regL1   = gset$regL1)
cvxr_am = extract_info_from_result(res,'disc_arb_cvxr',gset$Nmeas)
amm     = rbind(amm,cvxr_am)
```

## Simulated annealing
```{r annealing}
Lnow = c(1:gset$nrep) %>% as.list() %>%  mclapply(mc.cores=mc_cores,FUN=function(ii){
  var0_cts_arb_sa   = runif(gset$Nmeas) 
  opt_osc_power(dvar0  = var0_cts_arb_sa,
                                      control = ctrl_cts_arb_sa,
                                      freqs   = freqs_global,
                                      Amp     = NaN,
                                      cfuntype= 'ncp',
                                      regL1   = gset$regL1)
})
amm=update_amm(Lnow,gset,tag='cts_arb_sa',wrapped=F)

Lnow = c(1:gset$nrep) %>% as.list() %>%  mclapply(mc.cores=mc_cores,FUN=function(ii){
    var0_cts_lat_sa   = list(x0=c(shift2=1/2/Nmeas,scale1=0.5,scale2=.5,shift1=0),
                             lat1 =NULL,lat2 =NULL)
    resu_cts_lat_sa = wrapper_sweep_lattice(opt_osc_power,
                                Nvals    = c(gset$Nmin_2lat:gset$Nmax_2lat),
                                Nmeas    = gset$Nmeas,
                                cts_flag = T,
                                dvar0    = var0_cts_lat_sa,
                                control  = ctrl_cts_lat_sa,
                                freqs    = freqs_global,
                                Amp      = NaN,
                                cfuntype= 'ncp',
                                regL1   = gset$regL1)
})
amm=update_amm(Lnow,gset,tag='cts_lat_sa',wrapped=T)

Lnow = c(1:gset$nrep) %>% as.list() %>%  mclapply(mc.cores=mc_cores,FUN=function(ii){
    var0_disc_arb_sa = sample(c(1:Nfine),Nmeas) 
    resu_disc_arb_sa = opt_osc_power(dvar0  = var0_disc_arb_sa,
                                control = ctrl_disc_arb_sa,
                                freqs   = freqs_global,
                                Amp     = NaN,
                                tau     = tau,
                                cfuntype= 'ncp',
                                regL1   = gset$regL1)
})
amm=update_amm(Lnow,gset,tag='disc_arb_sa',wrapped=F)

Lnow = c(1:gset$nrep) %>% as.list() %>%  mclapply(mc.cores=mc_cores,FUN=function(ii){
    var0_disc_lat_sa = list(x0=c(dx1=1,dx2=1,xshift2=Nfine/2),N1=NULL,N2=NULL)
    resu_disc_lat_sa = wrapper_sweep_lattice(opt_osc_power,
                                  Nvals    = c(gset$Nmin_2lat:gset$Nmax_2lat),
                                  Nmeas    = Nmeas,
                                  cts_flag = F,
                                  dvar0    = var0_disc_lat_sa,
                                  control  = ctrl_disc_lat_sa,
                                  freqs    = freqs_global,
                                  Amp      = NaN,
                                  tau      = tau,
                                  cfuntype= 'ncp',
                                  regL1   = gset$regL1)
})
amm=update_amm(Lnow,gset,tag='disc_lat_sa',wrapped=T)
```

## Save simulations
```{r save-sims}
tstamp = now() %>% toString() %>%
  strsplit('\\.') %>% {.[[1]][1]} %>% 
  str_replace(' ','__')
outdir =paste0('results/output/Nmeas',gset$Nmeas,'/',
               'Nfi_',gset$Nfine,
               '_Nfr_',gset$Nfreq,
               '_rL1_',gset$regL1,
               '_msa_',gset$maxit_sa,
               '_mbf_',gset$maxit_bfgs,
               '_nrep_',gset$nrep,
               '_batch_',tstamp)
amm_file = paste0(outdir,'amm_all.RDS')
gset_file = paste0(outdir,'global_settings.RDS')
if (save_simulation){
  dir.create(paste0('results/output/Nmeas',toString(gset$Nmeas)))
  saveRDS(amm,amm_file)
  saveRDS(gset,gset_file)
}

```
# setup for plots
```{r setup-plots}
#fnames = read.csv('figs_for_paper/fnames.csv',header = F)
#amm_file=fnames$V1[1]
#amm=readRDS(file = amm_file)
#
## get global settings
#gset=readRDS(file=amm_file %>% str_replace('amm_all','global_settings'))
fs_glob=9
theme_set(theme_bw())

```

# Fig 1: Comparison of solvers

## Get highres power
```{r highres-power}
Nmeas=dim(amm)[2]
freqs_hd = seq(from=1,to=24,length.out=2^11)
amm@power = NaN
for (ii in c(1:dim(amm)[1])){
  amm@power[ii] = costfun_svdpower(amm[ii,],freqs_hd,Amp=2,alpha=.05)
}
```

## Plot best of each type
2 lattice, arbitrary, discrete, uniform
```{r plot-best}
amm@best='none'
pmax=amm[amm@lattice=='lat',] %>% {.@power} %>% max()
amm@best[amm@power==pmax & amm@lattice=='lat']='best_lattice'


pmax=amm[amm@lattice!='lat' & amm@cts=='disc',] %>% {.@power} %>% max()
amm@best[amm@power==pmax & amm@lattice!='lat' & amm@cts=='disc']='best_disc_free'

p1=amm[amm@best!='none',] %>% stack() %>%  ggplot(aes(x=value,y=ifelse(best=='best_lattice',1,-1)))+
  geom_point(aes(shape=factor(lattice,c('arb','lat'),c('none','2-lattice')),
                 color=factor(solver,c('cvxr','bfgs','sa'),c('DCP','BFGS','annealing'))),size=2)+
  labs(shape='Lattice constraint',
       color='Solver',
        y=element_blank(),
        x='time')+
    scale_color_manual(values=c('DCP'='red','BFGS'='blue','annealing'='cyan'))+
  theme(legend.position='none',
        axis.text.y=element_blank(),
        strip.background=element_blank(),
        text=element_text(size=fs_glob))+
  xlim(c(0,1))+ylim(c(-2,2))
p1
```

## Runtime vs performance
```{r runtime-perf}
p2=amm@'' %>% ggplot(aes(x=power,y=runtime))+
  geom_point(aes(shape=factor(lattice,c('arb','lat'),c('none','2-lattice')),
                 color=factor(solver,c('cvxr','bfgs','sa'),c('DCP','BFGS','annealing'))),size=1)+
  labs(shape='Lattice constraint',
       color='Solver',
        y='runtime [s]',
        x='worst case power')+
  facet_wrap(~factor(cts,c('cts','disc'),c('Continuous time','Discretised time (5 minute)')),nrow=2)+
  xlim(c(0,1))+
  scale_color_manual(values=c('DCP'='red','BFGS'='blue','annealing'='cyan'))

leg=get_legend(p2+theme(legend.position='bottom',
                        legend.box='vertical',
                        legend.margin = margin(),
                        strip.background=element_blank(),
                        text=element_text(size=fs_glob)
                        ))
p2=p2+theme(legend.position='none',
            strip.background=element_blank(),
            text=element_text(size=fs_glob))
```

## Power values
```{r power-curve}
amps=seq(from=0,to=3,by=.1)
freqs_sparse=seq(from=1,to=24,by=1)
tag   = c('uniform','best_disc_free','best_lattice')
pars  = expand.grid(amp=amps,tag=tag)

mt_unif = c(1:Nmeas)/Nmeas - 1/Nmeas
mt_lat  = amm[amm@best=='best_lattice',] 
mt_arb  = amm[amm@best=='best_disc_free',] 

# reg turned off because you actually want min power here
minPower= c(1:dim(pars)[1]) %>% as.list()%>%
  mclapply(mc.cores=mc_cores,FUN=function(ii){
  x=pars[ii,]
  if (x[['tag']]=='uniform'){
    mt_loc=mt_unif
  }else if(x[['tag']]=='best_lattice'){
    mt_loc=mt_lat
  }else if(x[['tag']]=='best_disc_free'){
    mt_loc=mt_arb
  }
    return(costfun_svdpower(mt=mt_loc,
                            freqs=freqs_hd,
                            Amp = as.numeric(x[['amp']]),
                            reg=0))
}) %>% unlist()
pars$minPower = minPower
```

```{r combine-F1}
p3=pars %>% ggplot(aes(x=amp,y=minPower,color=tag,group=tag))+geom_line()+
  scale_color_manual(values=c('best_lattice'='cyan','best_disc_free'='red',
                              'uniform'='black'))+
  labs( y='power',
        x='amplitude')+
  theme(legend.position = 'none',
        strip.background=element_blank(),
        text=element_text(size=fs_glob))+
  scale_y_continuous(limits=c(0,1),breaks=c(0,1))
p3
```

```{r save-F1}
pschem = as.ggplot(plot_spacer())+theme(
  text=element_text(size=fs_glob))
pcomp=as.ggplot((pschem/(p2| (p1/p3)))+
                plot_annotation(tag_levels='A')+
                  plot_layout(heights=c(2,3))
                  )
pcomp=pcomp+ggtitle(paste0('Nm=',Nmeas,' L1reg=',gset$regL1))
F1=(pcomp/leg)+plot_layout(heights=c(9,1))
F1
if (save_figures){
  saveRDS(file=amm_file %>% str_replace('amm_all','fig1'),F1)
}
```

# Fig 2: Benchmarking 
## Load designs
```{r prep-F2}
mt_unif = c(1:Nmeas)/Nmeas - 1/Nmeas
mt_lat  = amm[amm@best=='best_lattice',] 
mt_arb  = amm[amm@best=='best_disc_free',] 

am1=annmatrix(matrix(mt_unif,nrow = 1),data.frame(tag='uniform'))
am2=annmatrix(matrix(mt_lat,nrow=1),data.frame(tag='2-lattice'))
am3=annmatrix(matrix(mt_arb,nrow=1),data.frame(tag='arbitrary'))

am1$time=c(1:Nmeas) # necessary for rbind
am2$time=c(1:Nmeas) 
am3$time=c(1:Nmeas)
am = rbind(am1,am2,am3)
```

## Plot of actual sampling strategies
```{r sampling-F2}
am@tag = factor(am@tag,levels=c('uniform','2-lattice','arbitrary'))

colors=c('arbitrary'        = '#F57600',
         '2-lattice'        = '#0073e6',
         'uniform'          = 'black')
p1 =am %>% stack() %>% ggplot(aes(x=value,y=0,color=tag))+geom_point()+
  facet_wrap(~tag)+scale_color_manual(values=colors)+
  labs( y=element_blank(),
        x='time',
        color=element_blank())+
  theme(
    axis.text.y=element_blank(),
    axis.ticks.y=element_blank(),
    legend.position = 'none',       
    strip.background=element_blank(),
    text=element_text(size=fs_glob)
  )+scale_x_continuous(limits=c(0,1),breaks=seq(from=0,to=1,by=.5))

p1
  
```


## Power heatmap
```{r power-heatmap}
if (sparse_heatmap){
  amps  = seq(from=.5,3,by=1)
  freqs = seq(from=1,to=24,by=4)
}else{
  amps  = seq(from=.5,3,by=.1)
  freqs = seq(from=1,to=24,by=.01)
}
tag   = c('uniform','2-lattice','arbitrary')
pars  = expand.grid(amp=amps,freq=freqs,tag=tag)
minPower = rep(NaN,dim(pars)[1])
minPower =c(1:length(minPower)) %>% as.list() %>% lapply(
  function(ii){
    x=pars[ii,]
    if (x[['tag']]=='uniform'){
      mt_loc=mt_unif
    }else if(x[['tag']]=='2-lattice'){
      mt_loc=mt_lat
    }else if(x[['tag']]=='arbitrary'){
      mt_loc=mt_arb
    }
      return(costfun_svdpower(mt=mt_loc,
                              freqs=as.numeric(x[['freq']]),
                              Amp = as.numeric(x[['amp']])))
  }
)%>% unlist()
pars$minPower=minPower

p2=pars %>% ggplot(aes(x=amp,y=freq,fill=minPower))+geom_tile()+facet_wrap(~tag)+
  scale_fill_viridis_c(limits=c(0,1))+
  scale_x_continuous(breaks=seq(min(amps),max(amps),length.out=3))+
  scale_y_continuous(breaks=seq(0,max(freqs),length.out=5))+
  theme(strip.background=element_blank(),
    text=element_text(size=fs_glob))+
  labs(fill = 'power',
          y = 'frequency',
          x = 'amplitude')
p2
```


## Benchmark: worst-case FDR heatmap
```{r FDR-heatmap}
fmin=1
fmax=23.9

if (sparse_heatmap){
  Nmc=1e2
  NacroFDR=2^3
  NfreqFDR=2^3
  amps  = seq(from=.5,to=3,length.out=2^2)
  freqs = seq(from=1,to=24,length.out=2^2)
}else{
  Nmc=5e2
  NacroFDR=2^5
  NfreqFDR=2^5
  amps  = seq(from=.5,to=3,length.out=2^4)
  freqs = seq(from=1,to=24,length.out=2^4)
}
tag   = c('uniform','2-lattice','arbitrary')
fdrs = expand.grid(amp=amps,freq=freqs,tag=tag)
minFDR = replicate(dim(fdrs)[1],{NaN})
start=Sys.time()
minFDR= c(1:dim(fdrs)[1]) %>% as.list() %>% mclapply(function(ii){
  x=fdrs[ii,]
  if (x[['tag']]=='uniform'){
    mt_loc=mt_unif
  }else if(x[['tag']]=='2-lattice'){
    mt_loc=mt_lat
  }else if(x[['tag']]=='arbitrary'){
    mt_loc=mt_arb
  }
    return(benchmark_worst_fdr(mt = mt_loc,
                            f0    = as.numeric(x[['freq']]),
                            Amp   = as.numeric(x[['amp']]),
                            Nmc   = Nmc,
                            Nacro = NacroFDR,
                            Nfreq = NfreqFDR,
                            fmin  = fmin,
                            fmax  = fmax)
           )
  }) %>% unlist()
end=Sys.time()
end-start
fdrs$minFDR = minFDR
p3=fdrs %>% ggplot(aes(x=amp,y=freq,fill=minFDR))+geom_tile()+facet_wrap(~tag)+
  scale_fill_viridis_c(limits=c(0,1))+
  scale_x_continuous(breaks=seq(min(amps),max(amps),length.out=3))+
  scale_y_continuous(breaks=seq(0,max(freqs),length.out=5))+
  labs(fill = 'FDR',
          y = 'frequency',
          x = 'amplitude')+
  theme(strip.background=element_blank(),
    text=element_text(size=fs_glob))
p3
```


## Benchmark: parameter accuracy
```{r}

```

## Benchmark: Lomb-Scargle
```{r}

```

## Combine figs
```{r combine-F2}
pcomp= (p1/p2/p3)+plot_annotation(tag_levels='A')
pcomp=as.ggplot(pcomp)+ggtitle(paste0('Nm=',Nmeas,' L1reg=',gset$regL1))
pcomp
F2=pcomp
if (save_figures){
  saveRDS(file=amm_file %>% str_replace('amm_all','fig2'),F2)
}
```

```{r F1-F2}
F1 | F2
```
