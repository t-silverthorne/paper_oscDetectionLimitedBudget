This notebook is for the figures which appear in the paper before the theory section
```{r}
source('plotConfig.R')
source('utils/powerUtils.R')
source('utils/rowCosinor.R')
library(ggplot2)
library(dplyr)
library(annmatrix)
library(patchwork)
library(ggplot2)
library(ggplotify)
library(data.table)
library(pracma)
```

# Fig: motivation v2 
## Schedule with waveform shown
```{r}
theme_set(theme_bw())
vis_colors <- c("Alternative" = "blue", 'Uniform'='black')
N   = 12
Nmc = 1e3

t     = (0:N)/N
tunif = t[1:(length(t)-1)]

perw1 = c(.9*1/4,1.1*1/4)
perw2 = c(.9*1/6,1.1*1/6)

f0 = 5.8

N1 = 8
N2 = N - N1
tvec1 = (0:N1)/N1 
tvec2 = (0:N2)/N2 
tvec1 = tvec1[1:(length(tvec1)-1)]
tvec2 = tvec2[1:(length(tvec2)-1)]

talt = construct_sequential_design(0.3,tvec1,tvec2)

tdf = list(data.frame(time=tunif,value=0,type='unif'),
           data.frame(time=talt, value=0,type='alt')) %>% rbindlist()

td  = seq(from=0,to=1,by=.001)
yd  = cos(2*pi*td*f0-pi/2)#+1e-1*rnorm(length(td))
dfd = data.frame(time=td,signal=yd,type='unif')

yd   = cos(2*pi*td*f0-pi/2)#+1e-1*rnorm(length(td))
dfd2 = data.frame(time=td,signal=yd,type='alt')
dfd  = rbind(dfd,dfd2)

sched.labs = c('unif'='Uniform','alt'='Alternative')
tdf$type = factor(tdf$type,levels=names(sched.labs),labels=sched.labs)
dfd$type = factor(dfd$type,levels=names(sched.labs),labels=sched.labs)

PSCHED = ggplot()+geom_line(data=dfd,aes(x=24*time,y=signal))+ 
  geom_point(data=tdf,aes(x=24*time,y=value,color=type))+scale_color_manual(values=vis_colors)+
  facet_wrap(~type,nrow=2,strip.position = 'left')
PSCHED = control_labels(PSCHED,y_ticks=F) +
  theme(legend.position='none',panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  labs(x='time (hr)',y='signal')
PSCHED = PSCHED + scale_x_continuous(breaks = c(0, 8, 16, 24),limits = c(0,24))
PSCHED
```

## P-value distribution
```{r}
Nmc=1e2
Amp=2
freq=5.8
acro=0
monteCarloPval <-function(tvec,Amp,freq,acro){
  Ydat = replicate(Nmc,{Amp*cos(2*pi*freq*tvec -acro) + rnorm(length(tvec))}) %>% t
  return(rowCosinor(Ydat,tvec,per=1/freq) %>% {.$pvalue} )
}

acrovec = seq(from=0,to=2*pi,by=.05)

for (ii in c(1,2)){
  if (ii==1){
    tvec=tunif
    type='unif'
  }else{
    tvec=talt
    type='alt'
  }
  dfloc = lapply(acrovec %>% as.list(),function(x){
    acroRep = replicate(Nmc,x)
    typeRep = replicate(Nmc,{type})
    pv=monteCarloPval(tvec,Amp,freq,x)  
    return(data.frame(pval=pv,acro=acroRep,type=typeRep))
  }) %>% rbindlist()
  
  if (ii==1){
    df = dfloc
  }else{
    df = rbind(df,dfloc)
  }
}

sched.labs = c('unif'='Uniform','alt'='Alternative')
df$type = factor(df$type,levels=names(sched.labs),labels=sched.labs)

PPVAL = df %>% ggplot(aes(x=24*acro/2/pi/f0,y=pval))+
  geom_point(alpha=.2,size=.5)+
  geom_hline(aes(yintercept=.05,color='red'))+
  theme(legend.position='none',panel.grid.major = element_blank(),panel.grid.minor = element_blank())+      
  facet_wrap(~type,nrow=2,strip.position = 'left')+
  ylim(c(0,1))+labs(x='acrophase (hr)',y='oscillation p-value')#+
  #theme(strip.background = element_blank(),strip.text.y = element_blank())
PPVAL
```


## Power osc
```{r}
Nmc=5e2
Nout=3
# model params 
Amp  = 2
freq = 5.8 
acro = 1

# simulate and fit 
monteCarloPval <-function(tvec,Amp,freq,acro){
  Ydat = replicate(Nmc,{Amp*cos(2*pi*freq*tvec -acro) + rnorm(length(tvec))}) %>% t
  return(rowCosinor(Ydat,tvec,per=1/freq) %>% {.$pvalue <.05} %>% mean())
}

acrovec_sparse = seq(from=0,to=2*pi,by=.25)
for (ii in c(1,2)){
  if (ii==1){
    tvec=tunif
    type='unif'
  }else{
    tvec=talt
    type='alt'
    
  }
  dfloc = lapply(acrovec_sparse %>% as.list(),function(x){
    pwr=replicate(Nout,{monteCarloPval(tvec,Amp,freq,x)})
    return(data.frame(power=pwr,acro=replicate(Nout,{x}),type=replicate(Nout,{type})))
  }) %>% rbindlist()
  
  if (ii==1){
    df = dfloc
  }else{
    df = rbind(df,dfloc)
  }
}

param=list(Amp=Amp,
           acro=acro,
           freq=freq)

getPower_acro = function(acro,t,param){
  param$acro=acro
  return(getPower(t,param))
}
acrovec=seq(from=0,to=2*pi,by=.05)
pwrvec_unif=sapply(acrovec,function(x){getPower_acro(x,tunif,param)})
pwrvec_alt =sapply(acrovec,function(x){getPower_acro(x,talt,param)})
df_exact= data.frame(acro=acrovec,
                     power=pwrvec_unif,
                     type=replicate(length(acrovec),{'unif'}))

df_exact= rbind(df_exact,data.frame(acro=acrovec,
                                    power=pwrvec_alt,
                                    type=replicate(length(acrovec),{'alt'})))

df$type
sched.labs = c('unif'='Uniform','alt'='Alternative')
df_exact$type = factor(df_exact$type,levels=names(sched.labs),labels=sched.labs)
df$type       = factor(df$type,levels=names(sched.labs),labels=sched.labs)

PPWR = ggplot()+geom_point(data=df,aes(x=24*acro/2/pi/f0,y=power))+
  geom_line(data=df_exact,aes(x=24*acro/2/pi/f0,y=power))+ylim(c(0,1))+
  theme(legend.position='none',panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  facet_wrap(~type,nrow=2,strip.position='left')+labs(x='acrophase (hr)',y='power')#+
#  theme(strip.background = element_blank(),strip.text.y = element_blank())
```

```{r}
{PSCHED| PPVAL| PPWR}+plot_annotation(tag_levels = 'A')
ggsave(paste0(overleaf_plot_directory,"fig_motivation.pdf"), width = 7, height = 3)

```
# Fig: From power to non-centrality

## Mean power for various amplitudes and periods

Varying period looks nice but isnt as informative
```{r}
amps= seq(from=.5,to=5,by=.1)
pers= seq(from=1,to=4,by=.1)

tvec=tunif
apdf = expand.grid(amp=amps,period=pers)
apdf$minPower = apdf %>% apply(1,function(x){
  param$Amp  = x[['amp']]
  param$freq = 1/x[['period']]
  return(getMinPower(tvec,param))
  })
head(apdf)

apdf %>% ggplot(aes(x=amp,y=minPower,
                    group=period,
                    color=period))+geom_line()+scale_color_viridis_c()
```

Freq probably better
```{r}
amps= seq(from=.5,to=5,by=.1)
freqs = seq(from=1,to=12,by=.05)

tvec=tunif
apdf = expand.grid(amp=amps,freq=freqs)
apdf$minPower = apdf %>% apply(1,function(x){
  param$Amp  = x[['amp']]
  param$freq = x[['freq']]
  return(getMinPower(tvec,param))
  })
head(apdf)
```

```{r}
PMIN =apdf %>% mutate(circperiod = 24/freq) %>%  ggplot(aes(x=amp,y=minPower,
                    group=circperiod,
                    color=circperiod))+geom_line()+scale_color_viridis_c()+
  theme(legend.position='bottom',panel.grid.major = element_blank(),panel.grid.minor = element_blank())
```

Mean power
```{r}
tvec=tunif
acrovec=seq(from=0,to=2*pi,by=.1)
acrovec=acrovec[1:(length(acrovec)-1)]
apdf = expand.grid(amp=amps,freq=freqs)
apdf$meanPower = apdf %>% apply(1,function(x){
  param$Amp  = x[['amp']]
  param$freq = x[['freq']]
  return(mean(getPower_acrovec(tvec,param,acrovec)))
  })
```

```{r}
PMEAN = apdf %>% mutate(circperiod = 24/freq) %>%  ggplot(aes(x=amp,y=meanPower,
                    group=circperiod,
                    color=circperiod))+geom_line()+scale_color_viridis_c()+
#  theme(legend.position=c(0.6,.25),legend.direction = 'horizontal',panel.grid.major = element_blank(),panel.grid.minor = element_blank())
  theme(legend.position='none',panel.grid.major = element_blank(),panel.grid.minor = element_blank())

PMEAN =  control_labels(PMEAN,x_label=F,x_ticks = F)
```



```{r}
#{PDELTA | PMEAN/PMIN } + plot_annotation(tag_levels='A')
#ggsave(paste0(overleaf_plot_directory,"fig_framework.pdf"), width = 7, height = 3)

```


# Fig: amp variation and period variation
How is worst case power influenced by changes in amplitude and changes in period

## Amplitude part
```{r}
Ndes=5
# various designs
designsMAT = replicate(Ndes,{runif(N)}) %>% t() 
rownames(designsMAT) = paste0('rand_design_',c(1:Ndes))
designsMAT = rbind(designsMAT,tunif)

# various periods
freqlist = c(1,4,24/4.1) %>% as.numeric()

# various amplitudes
amps = seq(from=.1,to=5,by=.05)

optdf = expand.grid(rownames(designsMAT),freqlist,amps)
colnames(optdf) = c('design_name','freq','Amp')

pwrvec = apply(optdf,1,function(x){
  tloc       = designsMAT[rownames(designsMAT)==x[['design_name']], ]
  param$Amp  = as.numeric(x[['Amp']])
  param$freq = as.numeric(x[['freq']])
  return(getMinPower(tloc,param))
})
optdf$minpwr = pwrvec

head(optdf)

unif_vs_rand_colors <- c('Random' = "grey", 'Uniform'='black')
PAMP = optdf %>% mutate(period=1/freq) %>% mutate(circ_period = 24*period) %>% 
  mutate(is_unif = ifelse(design_name=='tunif','Uniform','Random')) %>%
  mutate(circ_period_label = paste0('T = ',round(circ_period,2),' hr')) %>% 
  ggplot(aes(x=Amp,y=minpwr,group=design_name,color=is_unif))+geom_line()+
  #scale_x_continuous(trans='log10')+
  facet_wrap(~reorder(circ_period_label,-circ_period))+scale_color_manual(values = unif_vs_rand_colors)+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  labs(color=NULL,y='minimum power',x='amplitude')+ylim(c(0,1))
```

## Period part
Illustrate detuning idea
```{r}
Nv=seq(from=8,to=24,by=2)
pers = seq(from=1/24,to=1,by=.01)

amps = c(1,1.5,3)

df = expand.grid(Nloc=Nv,period=pers,Amp=amps)
dfloc=df
dfloc$power_col = dfloc %>% apply(1,function(x){
  Nloc       = x[['Nloc']]
  tvec       = (0:Nloc)/Nloc
  tvec       = tvec[1:(length(tvec)-1)]
  param$Amp  = x[['Amp']]
  param$freq = 1/x[['period']]
  return(getMaxPower(tvec,param) - getMinPower(tvec,param))
})
dfloc$stat_type = 'delta'

df$power_col = df %>% apply(1,function(x){
  Nloc       = x[['Nloc']]
  tvec       = (0:Nloc)/Nloc
  tvec       = tvec[1:(length(tvec)-1)]
  param$Amp  = x[['Amp']]
  param$freq = 1/x[['period']]
  return(getMinPower(tvec,param))
})
df$stat_type = 'min'

df=rbind(df,dfloc)
stat_type.label = c('min'='Minimum','delta'='Delta')
df$stat_type = factor(df$stat_type,levels =names(stat_type.label),labels = stat_type.label)

PDELTA = df %>% mutate(circ_period=24*period) %>%
  mutate(amp_label=paste0('SNR = ',Amp)) %>% 
  ggplot(aes(x=circ_period,y=power_col,group=Nloc,color=Nloc))+
  geom_line()+
  facet_grid(stat_type~amp_label)+ scale_color_viridis_c()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  labs(color='N',x='period (hr)',y='power')+ylim(c(0,1))
```

```{r}
source('plotConfig.R')
{PAMP/PDELTA}+plot_annotation(tag_levels='A')+plot_layout(heights=c(1,1.5))
ggsave(paste0(overleaf_plot_directory,"fig_framework.pdf"), width = 7, height =4.5)

```

```{r}

```
# Fig: Optimization in reduced design space

## Template
```{r}


```










