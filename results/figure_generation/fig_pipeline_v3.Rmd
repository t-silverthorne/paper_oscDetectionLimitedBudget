```{r}
require(devtools)
require(annmatrix)
require(ggplot2)
require(ggplotify)
require(gurobi)
require(ggpubr)
require(patchwork)
require(parallel)
require(data.table)
require(stringr)
require(dplyr)
require(latex2exp)
require(annmatrix)
load_all()
source('plotConfig.R')
source('plot_template.R')
source('results/source/powerChord.R')
source('results/data/extract_data.R') 
get_legend <- function(p) {
   tmp <- ggplot_gtable(ggplot_build(p))
   leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
   legend <- tmp$grobs[[leg]]
   legend
}
#slide_version_directory='/home/turner/research/misc_tex/committee_meeting/figs/'
mc_cores=12
fsize=9
theme_set(theme_classic()) 
```

# Motivation: empirical p-values and power oscillations

## First part
```{r}
gen_panel_loc=function(mt){
  Nmeas =length(mt)
  mtdf=data.frame(time=mt)
  
  # panel 1 
  t_fine = seq(0,1,.005)
  freqs = c(1,4,9*.99)
  cp_levels = sort(24/freqs) %>% rev()
  cp_labels = round(cp_levels,2) %>%  {paste0(.,' hr')}
  phi_plt1=pi/2
  
  df = freqs %>% lapply(function(freq){
   data.frame(expr=cos(2*pi*freq*t_fine - phi_plt1),freq=freq,time=t_fine)
  }) %>% rbindlist() %>% data.frame()
  
  df_noise = freqs %>% lapply(function(freq){
   data.frame(expr=cos(2*pi*freq*mt - phi_plt1)+rnorm(length(mt)),
              freq=freq,time=mt)
  }) %>% rbindlist() %>% data.frame()
  df$circ_per=24/df$freq
  df$circ_per = factor(df$circ_per,cp_levels,cp_labels)
  df_noise$circ_per=24/df_noise$freq
  df_noise$circ_per = factor(df_noise$circ_per,cp_levels,cp_labels)
  p1=ggplot()+geom_line(data=df,aes(x=24*time,y=expr,group=circ_per,color=circ_per))+
    scale_color_manual(values = freq_colors)+
    geom_point(data=df_noise,aes(x=24*time,y=expr,color=circ_per),size=.5)+
    facet_wrap(~circ_per,nrow=3)+
    labs(y='simulated signal',x='time (hr)')+
    scale_x_continuous(limits=c(0,24),breaks = 4*c(0:6))+
    scale_y_continuous(limits=c(-3,3),n.breaks=3)
 
  # panel 2 
  Nmc=1e2
  monteCarloPval <-function(tvec,Amp,freq,acro){
    Ydat = replicate(Nmc,{Amp*cos(2*pi*freq*tvec -acro) + rnorm(length(tvec))}) %>% t
    return(rowCosinor(Ydat,tvec,per=1/freq) %>% {.$pvalue} )
  }
  acrovec=seq(from=0,to=2*pi,.05)
  pars=expand.grid(freq=freqs,acro=acrovec)
  
  #TODO: better way of doing this
  df=c(1:dim(pars)[1]) %>% lapply(function(ind){
    x=pars[ind,]
    freq=as.numeric(x['freq'])
    acro=as.numeric(x['acro'])
    return(data.frame(freq=freq,acro=acro,
                      pvalue=monteCarloPval(mt,Amp,freq,acro)))
  }) %>% rbindlist() %>% data.frame()
  
  
  df$circ_per=24/df$freq
  df$circ_per = factor(df$circ_per,cp_levels,cp_labels)
   
  p2=df %>% ggplot(aes(x=acro,y=-log10(pvalue),color=circ_per))+
    geom_point(size=.5,alpha=.2)+
    facet_wrap(~circ_per,nrow=3)+
    geom_hline(aes(yintercept =-log10(.05),linetype='p=0.05'),color='black')+
    scale_x_continuous(limits=c(0,2*pi),breaks =rad_brk,labels = rad_lab)+
    scale_y_continuous(limits =c(0,12),n.breaks = 2) +
    labs(x='acrophase (rad)',y='-log(pvalue)',linetype=element_blank())+
    scale_color_manual(values=freq_colors)+scale_linetype_manual(values=c('dashed'))+guides(color='none')
  plots=list()
  
  plots[[1]]=p1
  plots[[2]]=p2
  Fig=p1+p2 + plot_layout(guides='collect') & theme(legend.position='bottom',
     strip.background=element_blank(),
     text=element_text(size=fsize),
     plot.margin=margin(0,0,0,0),
     panel.grid.major = element_blank(),
     panel.grid.minor = element_blank(),
     axis.text.x = element_text(vjust = 0.25)
  )& labs(color='period')
 return(Fig) 
}


cols=viridisLite::viridisMap(3,begin=.3,end=.7,option='magma')
freq_colors=c(rgb(cols[1,c(1:3)]),rgb(cols[2,c(1:3)]),rgb(cols[3,c(1:3)]))
Nmeas = 18
mt_unif = c(1:Nmeas)/Nmeas-1/Nmeas

Amp = 3
Na  = 14
Nb  = Nmeas-Na
mta = c(1:Na)/Na-1/Na
mtb = c(1:Nb)/Nb-1/Nb
mt_alt  =c(mta/2,.5 + mtb/2) 

F1raw=gen_panel_loc(mt_unif)
F2raw=gen_panel_loc(mt_alt)
```

## Second part
```{r}
Amps = c(1,1.5,2)
Nacro=2^6+1
acros=seq(0,2*pi,length.out=Nacro)
acros=acros[1:(length(acros)-1)]

Nmvec = c(10,20,30)

Nfreq=2^8
freqs=seq(1,24,length.out=Nfreq)
pars=expand.grid(Amp=Amps,Nmeas=Nmvec,freq=freqs,acro=acros)

pars$power = c(1:dim(pars)[1]) %>% lapply(function(ii){
  x=pars[ii,]
  Amp   = x$Amp
  Nmeas = x$Nmeas
  acro  = x$acro
  freq  = x$freq
  mt = c(1:Nmeas)/Nmeas-1/Nmeas
  return(eval_exact_power(mt,param=list(Amp=Amp,acro=acro,freq=freq)))
})

pars$power = as.numeric(pars$power)

plt = pars %>% ggplot(aes(x=freq,y=acro,fill=power))+
  geom_raster()+
  facet_grid(Amp~Nmeas)+
  scale_y_continuous(limits=c(0,2*pi),breaks =rad_brk[c(1,3,5)],labels = rad_lab[c(1,3,5)])+
  scale_fill_viridis_c(limits=c(0,1))+
  labs(y='acrophase (rad)',x='frequency (cycles/day)')
```

## Combine
```{r}
plt = plt + 
  scale_y_continuous(sec.axis = sec_axis(~ . , name = "Amplitude", breaks = NULL, labels = NULL)) +
  scale_x_continuous(sec.axis = sec_axis(~ . , name = "Measurement budget", breaks = NULL, labels = NULL))+theme(axis.line.y.right = element_blank())+theme(axis.line.x.top = element_blank())
Fig = ((F1raw[[1]]|F1raw[[2]]|F2raw[[1]]| F2raw[[2]])/plt)+
  plot_annotation(tag_levels=list(c('A','','B','','C')))+
  plot_layout(guides='collect') &theme(legend.position='bottom') + 
  theme(text=element_text(size=fsize),
  strip.background=element_blank(),
  plot.margin = margin(0,0,0,0),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  axis.text.x = element_text(vjust = 0.25)
  )
show_temp_plt(Fig,plt_width = 6,plt_height = 5)
ggsave(paste0('~/research/ms_powerCHORD/figures/','motivation_fig_v2.png'),Fig,width=6,height=5,device='png',dpi=600)
```

# Applicability of non-uniform sampling 

```{r}
source('results/data/extract_fminfmax_data.R')
theme_set(theme_classic()) 
fdf$fmax = fdf$fmin+fdf$df
```

```{r}
plt = fdf %>% ggplot(aes(x=fmin,y=fmax,color=d_power))+geom_point(size=3)+facet_wrap(~Nmeas,nrow=1)+scale_color_viridis_c(limits=c(0,1)) 
plt_height = 3
plt_width  = 6

plt=plt+theme(text=element_text(size=fsize))

plt = plt + labs(x=element_text('min frequency (cycles/day)'),
                 y=element_text('max frequency (cycles/day)'),
                 color='gain of power')
plt
xmin=0
xmax=13
ymax=25
plt = plt + scale_x_continuous(limits =c(xmin,xmax),
                         breaks=seq(xmin,12,4),
                         labels=seq(xmin,12,4)) 

plt = plt + scale_y_continuous(limits =c(xmin,ymax),
                         breaks=seq(xmin,24,8),
                         labels=seq(xmin,24,8)) 

plt=plt+guides(fill=guide_colorbar(title.position='top'))
plt=plt+theme(legend.position='bottom',
               legend.key.width = unit(plt_width*.15, "in"),
               legend.title.align = 0.5,
               legend.direction = "horizontal")
plt = plt + theme(
  strip.background=element_blank(),
  plot.margin = margin(0,0,0,0),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  axis.text.x = element_text(vjust = 0.25)
  )
plt

plt = plt + 
  scale_x_continuous(sec.axis = sec_axis(~ . , name = "Measurement budget", breaks = NULL, labels = NULL))+theme(axis.line.x.top = element_blank())
show_temp_plt(plt,plt_width,plt_height)

ggsave(paste0('~/research/ms_powerCHORD/figures/','gain_of_non_unif.png'),plt,width=plt_width,height=plt_height,device='png',dpi=600)
```

# Optimal solution worst-case power

## Distribution of measurement points
```{r}
Nmeas_vals = c(20,40)
sloc = sols[sols@wreg==0&sols@drts==Inf,]
splt = sloc %>% stack()
splt = splt[splt$value<Inf,]

plt=splt[splt$Nmeas %in% Nmeas_vals, ] %>% ggplot(aes(x=value,y=0))+geom_point(size=.5)+facet_wrap(~Nmeas,nrow=length(Nmeas_vals))

plt = plt + theme(axis.title.y=element_blank()) 
plt = plt + theme(axis.text.y=element_blank()) 
plt = plt + labs(x=element_text('time (days)'))
plt = plt+scale_x_continuous(limits=c(0,1),breaks=c(0,1))
plt = plt + theme(
  strip.background=element_blank(),
  plot.margin = margin(0,0,0,0),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  axis.text.x = element_text(vjust = 0.25)
  )

plt_width=6
plt_height=3
show_temp_plt(plt,plt_width,plt_height)

psol=plt
```

## Power curve
```{r}
solvers=c('optimal','uniform')
freqs_pc=seq(1,24,length.out=2^10)
Amps=seq(0,2,length.out=50)
pars=expand.grid(solver=solvers,Nmeas=Nmeas_vals,Amp=Amps)
pwrvec = c(1:dim(pars)[1]) %>% mclapply(mc.cores=mc_cores,function(ii){
  # unpack
  x = pars[ii,]
  solver = x[['solver']]
  Nmeas  = as.numeric(x[['Nmeas']])
  Amp    = as.numeric(x[['Amp']])
  if(solver == 'uniform'){
    mt = c(1:Nmeas)/Nmeas-1/Nmeas 
  }else if(solver =='optimal'){
    mt=as.numeric(sloc[sloc@Nmeas==Nmeas,])
    mt=mt[mt<Inf]
  }else{
    stop('unknown type')
  }
  
  return(costfun_svdpower(mt,freqs_pc,Amp,cfuntype = 'power'))
})
pars$power =as.numeric(pwrvec)

plt=pars %>%ggplot(aes(x=Amp,y=power,group=solver,color=solver))+
  geom_line(show.legend=T)+
  scale_linetype_manual(values='dashed')+
  facet_wrap(~Nmeas,nrow=length(Nmeas_vals))+labs(x='amplitude',y='worst-case power')

plt = plt+labs(color=element_blank())
plt=plt+theme(legend.position='bottom',
               legend.key.width = unit(plt_width*.15, "in"),
               legend.title.align = 0.5,
               legend.direction = "horizontal")

plt = plt + theme(
  strip.background=element_blank(),
  plot.margin = margin(0,0,0,0),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  axis.text.x = element_text(vjust = 0.25)
  )


ymin=0
ymax=1
plt = plt + scale_y_continuous(limits =c(ymin,ymax),
                               breaks=c(ymin,ymax),
                               labels=round(c(ymin,ymax),2)) 



pcurve=plt
```
## Heatmap

```{r}
Nfreq_plt=2^7
Nacro=2^5+1
acros=seq(0,2*pi,length.out=Nacro)
acros=acros[1:(length(acros)-1)]
freqs_plt = seq(1,24,length.out=Nfreq_plt)

pars=expand.grid(Amp=c(1),Nmeas=Nmeas_vals,acro=acros,freq=freqs_plt,type=c('uniform','optimal'))

pwr_vec = c(1:dim(pars)[1]) %>% mclapply(mc.cores=mc_cores,function(ii){
  # unpack
  x      = pars[ii,]
  Nmeas  = as.numeric(x[['Nmeas']])
  acro   = as.numeric(x[['acro']])
  freq   = as.numeric(x[['freq']])
  Amp    = as.numeric(x[['Amp']]) 
  param =list(Amp=Amp,freq=freq,acro=acro) 
  
  if(x$type == 'uniform'){
    mt = c(1:Nmeas)/Nmeas-1/Nmeas 
  }else if(x$type =='optimal'){
    mt=as.numeric(sloc[sloc@Nmeas==Nmeas,])
    mt=mt[mt<Inf]
  }else{
    stop('unknown type')
  }
  power=eval_exact_power(mt,param)
  return(power)
})
pars$power = pwr_vec

pars$freq =as.numeric(pars$freq)
pars$acro =as.numeric(pars$acro)
pars$power=as.numeric(pars$power)

plt = pars%>%
  ggplot(aes(x=freq,y=acro,fill=power))+
  geom_raster()+
  facet_grid(Nmeas~type)+
  scale_y_continuous(limits=c(0,2*pi),breaks =rad_brk[c(1,3,5)],labels = rad_lab[c(1,3,5)])+
  scale_fill_viridis_c(limits=c(0,1))+
  labs(y='acrophase (rad)',x='frequency (cycles/day)')


```

```{r}
plt=plt+theme(legend.position='bottom',
               legend.key.width = unit(plt_width*.05, "in"),
               legend.title.align = 0.5,
               legend.direction = "horizontal")

plt = plt + theme(
  strip.background=element_blank(),
  plot.margin = margin(0,0,0,0),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  axis.text.x = element_text(vjust = 0.25)
  )
phmap = plt
```

## Combine

```{r}
Fig =  phmap/(psol + pcurve)  +
  plot_annotation(tag_levels='A')+
  plot_layout(heights=c(1,1))+
  plot_layout(guides='collect') & theme(
  legend.position='bottom',
  text=element_text(size=fsize),
  strip.background=element_blank(),
  plot.margin = margin(0,0,0,0),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  axis.text.x = element_text(vjust = 0.25)
  )

plt_width=6
plt_height=4

show_temp_plt(Fig,plt_width,plt_height)
ggsave(paste0('~/research/ms_powerCHORD/figures/','result_first_heatmap.png'),Fig,width=plt_width,height=plt_height,device='png',dpi=600)
```

# Degeneracy and regularization
## Ultradian/infradian figure 
```{r}
ncp = function(mt,f){
  sum(cos(2*pi*mt*f)^2)
}

dncp = function(mt,f){
  sum(-4*pi*mt*cos(2*pi*mt*f)*sin(2*pi*mt*f))
}

Nmeas      = 10 
mt         = c(1:Nmeas)/Nmeas - 1/Nmeas
delta_vals = seq(0,2,.01)
freq_vals  = seq(Nmeas/2-1,Nmeas/2+1,.01)

pars = expand.grid(delta=delta_vals,freq=freq_vals)

fvals = c(1:dim(pars)[1]) %>% mclapply(mc.cores=12,function(ii){
  # unpack
  x     = pars[ii,]
  freq  = x$freq
  delta = x$delta
  
  return(data.frame(ncp=ncp(mt+delta,freq),dncp=dncp(mt+delta,freq)))
  }
) %>% rbindlist() %>% data.frame()

pars = cbind(pars,fvals)

head(pars)

theme_set(theme_classic()) 
plt_width=2
# function plot
plt_width=6
plt_height=2

plt = pars %>% ggplot(aes(x=delta,y=freq,fill=ncp))+geom_raster()+scale_fill_viridis_c()
plt = plt + labs(x=element_text('shift (days)'),
                 y=element_text('frequency (cycles/day)'),
                 fill=TeX('$\\lambda(t;A,f,\\phi)$'))
plt=plt+guides(fill=guide_colorbar(title.position='right'))
plt=plt+theme(legend.key.height = unit(plt_height*.1, "in"),
               legend.title = element_text(angle = 90),
               legend.title.align = 0.5,
               legend.direction = "vertical")
plt_f = plt

# derivative plot
plt = pars %>% ggplot(aes(x=delta,y=freq,fill=dncp))+geom_raster()+scale_fill_viridis_c(option='B')
plt = plt + labs(x=element_text('shift (days)'),
                 y=element_text('frequency (cycles/day)'),
                 fill=TeX('$\\partial_f \\; \\lambda(t;A,f,\\phi)$'))
plt=plt+guides(fill=guide_colorbar(title.position='right'))
plt=plt+theme(legend.key.height = unit(plt_height*.1, "in"),
               legend.title = element_text(angle = 90),
               legend.title.align = 0.5,
               legend.direction = "vertical")
plt=plt+theme(text=element_text(size=9))
plt_df = plt

plt_hmap = plt_f | plt_df
plt_hmap = plt_hmap & theme(text=element_text(size=fsize))
show_temp_plt(plt_hmap,plt_width,plt_height)
ggsave(paste0('~/research/ms_powerCHORD/figures/','regularization_fig0.png'),plt_hmap,width=plt_width,height=plt_height,device='png',dpi=600)
```

## Pure regularization
### Raw solutions 
```{r}
scale=1.4
tau   = c(1:Nfine)/Nfine -1/Nfine 

Nfine = floor(144*scale/3)
Nmeas = floor(40*scale)
fmax  = 45
fmin_vals = c(1,10,20)
sols = c(1:length(fmin_vals)) %>% lapply(function(ii){
  fmin = fmin_vals[ii]
  sol=powerChord(Nmeas       = Nmeas,
                 drts        = Inf,
                 w_reg       = 1,
                 Nfreq       = 8,
                 num_threads = 12,
                 tlim        = 10,
                 Nfine       = Nfine,
                 w_wc        = 0,
                 fmin        = fmin,
                 fmax        = fmax,
                 MIPGap      = 1e-12
                 ) 
  return(data.frame(fmin=fmin,mt=tau[sol$x[1:Nfine]>0]))
}) %>% rbindlist() %>% data.frame()
head(sols)

plt = sols %>% ggplot(aes(x=mt,y=1))+geom_point(size=1)+
  facet_wrap(~fmin,nrow=3)+
  scale_x_continuous(limits=c(0,1))
plt = plt + theme(axis.title.y=element_blank()) 

plt = plt + theme(axis.text.y=element_blank()) 
plt = plt + labs(x=element_text('time (days)'))
plt = plt+scale_x_continuous(limits=c(0,1),breaks=c(0,1))
plt = plt + theme(
  strip.background=element_blank(),
  plot.margin = margin(0,0,0,0),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  axis.text.x = element_text(vjust = 0.25)
  )
plt=plt+theme(text=element_text(size=9))
plt_raw = plt
plt_raw 
```

### Applicability 
```{r}
pdf = readRDS('results/data/pure_reg.RDS')
pdf = pdf %>% mutate(outcome = ifelse(status=='TIME_LIMIT','time_out',is_unif))
pdf = pdf %>% filter(cfactor<=2)
pdf$outcome = factor(pdf$outcome,c(T,F,'time_out'),c('uniform optimal','non-uniform optimal','timeout'))
plt = pdf %>% ggplot(aes(x=Nmeas,y=fmax,fill=outcome))+ geom_raster()+
  facet_wrap(~cfactor)


plt_height = 2.25
plt_width  = 6

# theme
theme_set(theme_classic()) 

# font size

plt = plt + labs(x=element_text('measurement budget'),
                 y=element_text('max frequency (cycles/day)'))
plt=plt+guides(fill=guide_legend(title.position='top'))
plt=plt+theme(legend.position='bottom',
               legend.key.width = unit(plt_width*.05, "in"),
               legend.title.align = 0.5,
               legend.direction = "horizontal",
                text = element_text(size=9))
# misc visuals
plt = plt + theme(
  strip.background=element_blank(),
  plot.margin = margin(0,0,0,0),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  axis.text.x = element_text(vjust = 0.25)
)
plt=plt+theme(text=element_text(size=9))


plt=plt+scale_x_continuous(sec.axis = sec_axis(~ . , name = "Temporal resolution scale factor", breaks = NULL, labels = NULL))+
  theme(axis.line.x.top = element_blank()) 
plt_app = plt

plt_app
```

### Combine
```{r}
plt_width =6 
plt_height=5
plt_raw = plt_raw
plt_app = plt_app
Fig = plt_raw/plt_app  + plot_annotation(tag_levels='A')+
  plot_layout(heights=c(1.5,2))
show_temp_plt(Fig,plt_width,plt_height)
ggsave(paste0('~/research/ms_powerCHORD/figures/','pure_regularization.png'),Fig,width=plt_width,height=plt_height,device='png',dpi=600)
```

## Augmented cost function
### Degeneracy heatmap
```{r}
get_exact_reg = function(tau,fmin,fmax){
  dtau_mat          = outer(tau,tau,'-')
  tau_prod_mat      = outer(tau,tau,'*')
  ncp_reg_mat       = ((sin(4*pi*fmax*dtau_mat) - sin(4*pi*fmin*dtau_mat))*(4*tau_prod_mat*pi^2 + 1))/(4*dtau_mat)
  diag(ncp_reg_mat) = pi*(4*pi^2*tau^2 + 1)*(fmax - fmin) 
  return(sum(sum(ncp_reg_mat)))
}

# compute power with/without regularization
eval_reg_cfun = function(mt,freqs,w_reg){
  # worst-case non-centrality
  ncp = freqs %>% sapply(function(freq){
    getReducedFIM(mt,list(freq=freq)) %>% 
    {getMinEig(.,is_symmetric=T)} 
    })%>% min()
  # for regularization term
  fmin = min(freqs)
  fmax = max(freqs)
  # result
  return(ncp-w_reg*get_exact_reg(mt,fmin,fmax))
}
```

```{r}
nt      = 60*2
Nfreq   = 2^7
Nm      = 24 
fmin    = 1 
fmaxs   = c(6,12,24)
mt_unif = c(1:Nm)/Nm - 1/Nm

ta_vals = seq(0,.5,length.out=nt)
tb_vals = seq(0,.5,length.out=nt)
pars    = expand.grid(ta=ta_vals,tb=tb_vals,fmax=fmaxs,wreg=c(0,1))

pars    = pars[pars$ta < pars$tb,]
pars    = pars[!(pars$ta %in% mt_unif),]
pars    = pars[!(pars$tb %in% mt_unif),]

pars$power = c(1:dim(pars)[1]) %>% mclapply(mc.cores=mc_cores,function(ii){
  x     = pars[ii,]
  ta    = x$ta %>% as.numeric()
  tb    = x$tb %>% as.numeric()
  fmax  = x$fmax %>% as.numeric()
  wreg  = x$wreg %>% as.numeric()
  
  mt    = c(mt_unif,ta,tb) 
  
  freqs = seq(fmin,fmax,length.out=Nfreq)
  
  return(eval_reg_cfun(mt,freqs,wreg))
})

pars$power = as.numeric(pars$power)
pars = pars %>% group_by(wreg,fmax) %>% 
  mutate(gmax = max(abs(power))) %>% ungroup()

pars = pars %>% group_by(wreg,fmax) %>% 
  mutate(power_norm = power/gmax) %>% ungroup()
```

```{r}
theme_set(theme_classic()) 
plt1=pars %>% filter(wreg==0) %>% ggplot(aes(x=ta,y=tb,fill=power_norm))+geom_raster()+scale_fill_viridis_c()+
  facet_wrap(~fmax,nrow=1)

plt2=pars %>% filter(wreg>0) %>% ggplot(aes(x=ta,y=tb,fill=power_norm))+geom_raster()+scale_fill_viridis_c()+
  facet_wrap(~fmax,nrow=1)


plt1 = plt1 & scale_x_continuous(limits =c(xmin,xmax),
                               breaks=c(xmin,xmax),
                               labels=round(c(xmin,xmax),2)) 
plt1 = plt1 & scale_y_continuous(limits =c(ymin,ymax),
                               breaks=c(ymin,ymax),
                               labels=round(c(ymin,ymax),2)) 
plt2 = plt2 & scale_x_continuous(limits =c(xmin,xmax),
                               breaks=c(xmin,xmax),
                               labels=round(c(xmin,xmax),2)) 
plt2 = plt2 & scale_y_continuous(limits =c(ymin,ymax),
                               breaks=c(ymin,ymax),
                               labels=round(c(ymin,ymax),2)) 


plt1 = plt1 + scale_x_continuous(sec.axis = sec_axis(~ . , name = "max frequency (cycles/day)", breaks = NULL, labels = NULL))+theme(axis.line.x.top = element_blank())

plt = plt1/plt2
plt
```

```{r}

plt=plt&theme(text=element_text(size=fsize))

xmin=0
xmax=.5
ymin=0
ymax=.5

plt = plt & labs(x=TeX('$t_1$'),
                 y=TeX('$t_2$'),
                 fill='objective')

plt=plt&guides(fill=guide_colorbar(title.position='right'))
plt=plt&theme(legend.key.height = unit(plt_height*.06, "in"),
               legend.title = element_text(angle = 90),
               legend.title.align = 0.5,
               legend.direction = "vertical")


plt = plt & theme(
  strip.background=element_blank(),
  plot.margin = margin(0,0,0,0),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  axis.text.x = element_text(vjust = 0.25))


plt_degen = plt
show_temp_plt(plt,plt_width,plt_height)
```

### Relative performance
Solutions normalized by unconstrained unregularized problem
```{r}
source('results/data/extract_data.R') 
# all solutions that don't have regularization
sols_plt = sols[sols@wreg %in% c(0,1),]
df = sols_plt@''

# calculate figure of merit relative to uniform

df_free =df %>% group_by(Nmeas) %>%
  filter(drts==Inf & wreg==0) %>% 
  mutate(free_ncp = ncp) %>%
  ungroup()

df = left_join(df,df_free[,c('Nmeas','free_ncp')]) 

df = df %>% filter(wreg>0 & drts == Inf)

df = df %>% group_by(Nmeas) %>% 
  mutate(norm_ncp = ncp/free_ncp) %>% 
  ungroup()

plt = df %>% 
  ggplot(aes(x=Nmeas,y=norm_ncp))+
  geom_point(size=1)

xmin = 16
xmax = 48

plt=plt + labs(x=element_text('measurement budget'),
           y=element_text('relative score'),
           color=element_text('constraint'),
           shape=element_text('regularisation'))

plt=plt+theme(text=element_text(size=fsize))

plt = plt + scale_x_continuous(limits =c(xmin,xmax),
                               breaks=seq(xmin,xmax,8),
                               labels=seq(xmin,xmax,8))
plt=plt+guides(color=guide_legend(title.position='right'))


plt=plt+theme(legend.key.height = unit(plt_height*.15, "in"),
               legend.title = element_text(angle = 90),
               legend.title.align = 0.5,
               legend.direction = "vertical")


plt = plt + theme(
  strip.background=element_blank(),
  plot.margin = margin(0,0,0,0),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  axis.text.x = element_text(vjust = 0.25)
  )

plt_reg_conv = plt

plt_height=2.5
show_temp_plt(plt,plt_width,plt_height)

```

### Raw solutions
```{r}
Nmeas_vals = c(16,20,40)
sloc = sols[sols@wreg==1&sols@drts==Inf,]
splt = sloc %>% stack()
splt = splt[splt$value<Inf,]

plt=splt[splt$Nmeas %in% Nmeas_vals, ] %>% ggplot(aes(x=value,y=0))+geom_point(size=.5)+facet_wrap(~Nmeas,nrow=length(Nmeas_vals))

plt = plt + theme(axis.title.y=element_blank()) 
plt = plt + theme(axis.text.y=element_blank()) 
plt = plt + labs(x=element_text('time (days)'))
plt = plt+scale_x_continuous(limits=c(0,.3),breaks=c(0,.3))
plt = plt + theme(
  strip.background=element_blank(),
  plot.margin = margin(0,0,0,0),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  axis.text.x = element_text(vjust = 0.25)
  )

plt_width=6
plt_height=3
show_temp_plt(plt,plt_width,plt_height)

psol=plt
```
### Heatmaps

```{r}
Nfreq_plt=2^7
Nacro=2^5+1
acros=seq(0,2*pi,length.out=Nacro)
acros=acros[1:(length(acros)-1)]
freqs_plt = seq(1,24,length.out=Nfreq_plt)

pars=expand.grid(Amp=c(1),Nmeas=Nmeas_vals,acro=acros,freq=freqs_plt)

pwr_vec = c(1:dim(pars)[1]) %>% mclapply(mc.cores=mc_cores,function(ii){
  # unpack
  x      = pars[ii,]
  Nmeas  = as.numeric(x[['Nmeas']])
  acro   = as.numeric(x[['acro']])
  freq   = as.numeric(x[['freq']])
  Amp    = as.numeric(x[['Amp']]) 
  param =list(Amp=Amp,freq=freq,acro=acro) 
  
  mt=as.numeric(sloc[sloc@Nmeas==Nmeas,])
  mt=mt[mt<Inf]
  power=eval_exact_power(mt,param)
  return(power)
})
pars$power = pwr_vec

pars$freq =as.numeric(pars$freq)
pars$acro =as.numeric(pars$acro)
pars$power=as.numeric(pars$power)

plt = pars%>%
  ggplot(aes(x=freq,y=acro,fill=power))+
  geom_raster()+
  facet_wrap(~Nmeas)+
  scale_y_continuous(limits=c(0,2*pi),breaks =rad_brk[c(1,3,5)],labels = rad_lab[c(1,3,5)])+
  scale_fill_viridis_c(limits=c(0,1))+
  labs(y='acrophase (rad)',x='frequency (cycles/day)')

plt=plt+guides(fill=guide_colorbar(title.position='right'))
plt=plt+theme(legend.key.height = unit(.15, "in"),
               legend.title = element_text(angle = 90),
               legend.title.align = 0.5,
               legend.direction = "vertical")

plt = plt + theme(
  strip.background=element_blank(),
  plot.margin = margin(0,0,0,0),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  axis.text.x = element_text(vjust = 0.25)
  )
plt = plt +  scale_x_continuous(sec.axis = sec_axis(~ . , name = "Measurement budget", breaks = NULL, labels = NULL))+theme(axis.line.x.top = element_blank())

plt_hmap=plt
plt_hmap
```

### Combine
```{r}
plt_degen    = plt_degen & theme(text=element_text(size=9))
plt_reg_conv = plt_reg_conv & theme(text=element_text(size=9))
psol         = psol& theme(text=element_text(size=9))
plt_hmap     = plt_hmap & theme(text=element_text(size=9))

Fig = (plt_degen/(plt_reg_conv+psol)/plt_hmap )+
  plot_annotation(tag_levels='A')+
  plot_layout(heights = c(1,1,1,1))

plt_width  = 6
plt_height = 7
show_temp_plt(Fig,plt_width,plt_height)
ggsave(paste0('~/research/ms_powerCHORD/figures/','regularization_part2.png'),Fig,width=plt_width,height=plt_height,device='png',dpi=600)
```

# Performance of constrained solver

## Convergence

New version
```{r}
# all solutions that don't have regularization
sols_plt = sols[sols@wreg %in% c(0),]
df = sols_plt@''

# calculate figure of merit relative to uniform

df_free =df %>% group_by(Nmeas) %>%
  filter(drts==Inf) %>% 
  mutate(free_ncp = ncp) %>%
  ungroup()

df = left_join(df,df_free[,c('Nmeas','free_ncp')]) 

df = df %>% filter(drts<Inf)

df = df %>% group_by(Nmeas) %>% 
  mutate(norm_ncp = ncp/free_ncp) %>% 
  ungroup()

plt = df %>% 
  ggplot(aes(x=Nmeas,y=norm_ncp,color=as.factor(drts)))+
  geom_point(size=1)+
  facet_wrap(~stat_code)

xmin = 16
xmax = 48

plt=plt + labs(x=element_text('measurement budget'),
           y=element_text('relative score'),
           color=element_text('constraint'),
           shape=element_text('regularisation'))

plt=plt+theme(text=element_text(size=fsize))

plt = plt + scale_x_continuous(limits =c(xmin,xmax),
                               breaks=seq(xmin,xmax,8),
                               labels=seq(xmin,xmax,8))
plt=plt+guides(color=guide_legend(title.position='right'))


plt=plt+theme(legend.key.height = unit(plt_height*.15, "in"),
               legend.title = element_text(angle = 90),
               legend.title.align = 0.5,
               legend.direction = "vertical")


plt = plt + theme(
  strip.background=element_blank(),
  plot.margin = margin(0,0,0,0),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  axis.text.x = element_text(vjust = 0.25)
  )

plt_conv = plt

plt_height=2.5
show_temp_plt(plt,plt_width,plt_height)
```

## Heatmap

```{r}
Nmeas_vals = c(24,40)
sloc = sols[sols@wreg==0&sols@drts<Inf,]
splt = sloc %>% stack()
splt = splt[splt$value<Inf,]

Nfreq_plt=2^7
Nacro=2^5+1
acros=seq(0,2*pi,length.out=Nacro)
acros=acros[1:(length(acros)-1)]
freqs_plt = seq(1,24,length.out=Nfreq_plt)

pars=expand.grid(Amp=c(1),Nmeas=Nmeas_vals,acro=acros,freq=freqs_plt,
                 drts=c(6,12,18))

pwr_vec = c(1:dim(pars)[1]) %>% mclapply(mc.cores=mc_cores,function(ii){
  # unpack
  x      = pars[ii,]
  Nmeas  = as.numeric(x[['Nmeas']])
  acro   = as.numeric(x[['acro']])
  freq   = as.numeric(x[['freq']])
  Amp    = as.numeric(x[['Amp']]) 
  drts   = as.numeric(x[['drts']]) 
  param =list(Amp=Amp,freq=freq,acro=acro) 
  
  mt=as.numeric(sloc[sloc@Nmeas==Nmeas &sloc@drts==drts,])
  mt=mt[mt<Inf]
  power=eval_exact_power(mt,param)
  return(power)
})
pars$power = pwr_vec

pars$freq =as.numeric(pars$freq)
pars$acro =as.numeric(pars$acro)
pars$power=as.numeric(pars$power)

plt = pars%>%
  ggplot(aes(x=freq,y=acro,fill=power))+
  geom_raster()+
  facet_grid(drts~Nmeas)+
  scale_y_continuous(limits=c(0,2*pi),breaks =rad_brk[c(1,3,5)],labels = rad_lab[c(1,3,5)])+
  scale_fill_viridis_c(limits=c(0,1))+
  labs(y='acrophase (rad)',x='frequency (cycles/day)')

theme_set(theme_classic()) 
plt=plt+theme(text=element_text(size=fsize))
plt = plt + theme(
  strip.background=element_blank(),
  plot.margin = margin(0,0,0,0),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  axis.text.x = element_text(vjust = 0.25)
  )


plt = plt + 
  scale_y_continuous(sec.axis = sec_axis(~ . , name = "Constraint (10 min intervals)", breaks = NULL, labels = NULL)) +
  scale_x_continuous(sec.axis = sec_axis(~ . , name = "Measurement budget", breaks = NULL, labels = NULL))+
  theme(axis.line.x.top = element_blank())+
  theme(axis.line.y.right = element_blank())
p_hmap = plt
```

## Combine
```{r}
#TODO check font sizing is consistent, does it depend on where you put plot_annotation
Fig = plt_conv/p_hmap + plot_annotation(tag_levels='A')

plt_width=6
plt_height=4
show_temp_plt(Fig,plt_width,plt_height)

ggsave(paste0('~/research/ms_powerCHORD/figures/','sampling_constraint_hmap.png'),Fig,width=plt_width,height=plt_height,device='png',dpi=600)

```

