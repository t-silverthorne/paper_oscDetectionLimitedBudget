
```{r}
library(dplyr)
N     = 1e2
d     = 50;
x     = rnorm(N*d) %>%  matrix(nrow=N*d)

# parameters
beta  = .1 
gamma = 1 

# true impulse response
tvec     = (1:d)
thetavec = ifelse(tvec<=10,exp(-1/(1-(tvec/5-1)^2)),0)


# construct regression matrix
Phi = matrix(rep(0,N*d),nrow=N,ncol=d)
for (ii in c(1:N)){
  Phi[ii,] = x[(ii-1) + 1:d]
}
Y=Phi%*%thetavec

# construct 
Sigma=matrix(rep(0,d*d),nrow=d,ncol=d)

for (ii in c(1:d)){
  for (jj in c(1:d)){
    Sigma[ii,jj]=exp(-beta*max(ii,jj))
  }
}

theta_est = pracma::mldivide(t(Phi)%*%Phi+gamma*pracma::inv(Sigma),t(Phi))%*%Y

am_true   = annmatrix(t(thetavec),rann=data.frame(type='exact'),cann=data.frame(time=tvec))
am_est    = annmatrix(t(theta_est),rann=data.frame(type='estimate'),cann=data.frame(time=tvec))
am        = rbind(am_true,am_est)

am %>% stack() %>% ggplot(aes(x=time,y=value,color=type))+geom_line()+geom_point()

```